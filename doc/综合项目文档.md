# 基于ZigBee无线传感器网络的智能牛棚环境监测系统

## 综合项目文档

---

## 📑 文档信息

| 项目 | 内容 |
|------|------|
| **项目名称** | 基于ZigBee无线传感器网络的智能牛棚环境监测系统 |
| **文档版本** | v2.0 |
| **编制日期** | 2025年12月 |
| **系统版本** | v2.0（含产奶量预测与智能阈值升级） |
| **技术架构** | Vue 3 + Spring Boot + MySQL + Python |

---

## 目录

1. [背景介绍](#一背景介绍)
2. [需求分析](#二需求分析)
3. [功能设计](#三功能设计)
4. [软硬件模块设计](#四软硬件模块设计)
5. [传感器网络数据](#五传感器网络数据)
6. [融合分析决策](#六融合分析决策)
7. [网关设计](#七网关设计)
8. [应用界面网页](#八应用界面网页)
9. [具体工作](#九具体工作)
10. [系统完成](#十系统完成)
11. [系统测试](#十一系统测试)

---

## 一、背景介绍

### 1.1 项目背景

随着现代畜牧业的集约化发展，牛棚环境质量直接影响奶牛的健康状况和产奶量。传统的人工巡检方式存在以下问题：

| 问题类型 | 具体表现 |
|---------|---------|
| **监测不连续** | 无法实现24小时实时监测，存在监控盲区 |
| **数据不准确** | 人工读数易出错，缺乏历史数据对比分析 |
| **响应滞后** | 环境异常时无法及时发现和处理，造成损失 |
| **人力成本高** | 需要专人定期巡检记录，效率低下 |

牛棚环境中的关键参数及其影响：

| 参数 | 适宜范围 | 对奶牛的影响 |
|-----|---------|------------|
| **温度** | 5-25°C | 影响奶牛舒适度和产奶量，过高导致热应激 |
| **湿度** | 50-70% | 影响呼吸道健康，过高易滋生细菌 |
| **氨气（NH₃）** | <25 ppm | 刺激性气体，影响呼吸系统和食欲 |
| **硫化氢（H₂S）** | <10 ppm | 有毒气体，危害神经系统和健康 |

### 1.2 技术背景

#### 1.2.1 无线传感器网络（WSN）

无线传感器网络（Wireless Sensor Network, WSN）是由大量传感器节点组成的自组织网络，能够协同感知、采集和处理网络覆盖区域内的监测对象信息。

**核心特点**：
- 🔹 分布式数据采集与处理
- 🔹 自组织网络拓扑
- 🔹 多跳路由数据传输
- 🔹 资源受限（能量、计算、存储）

#### 1.2.2 ZigBee技术

ZigBee是一种基于IEEE 802.15.4标准的低功耗、低速率无线通信协议，特别适合传感器网络应用。

| 特性 | 说明 |
|-----|------|
| **低功耗** | 电池供电可工作数月至数年 |
| **低成本** | 芯片和模块价格低廉 |
| **低速率** | 传输速率250kbps，满足传感器数据需求 |
| **自组网** | 支持星型、树型、网状拓扑，节点可自动入网 |
| **高容量** | 单个网络可容纳65000个节点 |
| **安全性** | 支持AES-128加密 |

### 1.3 项目意义

本项目通过构建基于ZigBee的无线传感器网络，结合现代Web技术和数据分析算法，实现：

- ✅ **实时监测**：牛棚环境参数24小时不间断采集
- ✅ **智能分析**：THI/AQI指数计算，产奶量预测
- ✅ **自动告警**：多级告警系统，超标自动触发
- ✅ **设备联动**：根据环境参数自动控制通风、供热设备
- ✅ **数据可视化**：Web端实时展示，历史趋势分析
- ✅ **动态阈值**：智能调整告警阈值，避免误报漏报

### 1.4 项目范围

本项目为**模拟仿真系统**，通过软件模拟实现：
- 传感器数据采集（Python模拟器）
- ZigBee网络通信（Socket通信）
- 数据处理与存储（Spring Boot + MySQL）
- 可视化展示与控制（Vue 3 + ECharts）

---

## 二、需求分析

### 2.1 功能性需求

#### 2.1.1 数据采集需求

| 需求编号 | 需求描述 |
|---------|---------|
| FR-1.1 | 支持多个传感器节点同时工作（3-10个节点） |
| FR-1.2 | 每个节点采集温度、湿度、NH₃、H₂S四种参数 |
| FR-1.3 | 采集周期可配置（默认30秒/次，支持10-60秒） |
| FR-1.4 | 数据包含时间戳、节点ID、位置信息 |
| FR-1.5 | 支持正常、异常、混合三种数据生成模式 |

#### 2.1.2 数据传输需求

| 需求编号 | 需求描述 |
|---------|---------|
| FR-2.1 | 传感器节点通过ZigBee网络发送数据至协调器 |
| FR-2.2 | 协调器通过Socket/串口上传数据至服务器 |
| FR-2.3 | 传输延迟控制在5秒以内 |
| FR-2.4 | 支持数据完整性校验（校验和验证） |
| FR-2.5 | 通信异常时支持自动重连 |

#### 2.1.3 数据存储需求

| 需求编号 | 需求描述 |
|---------|---------|
| FR-3.1 | 所有历史数据存储在MySQL数据库 |
| FR-3.2 | 支持按时间、节点、参数类型查询 |
| FR-3.3 | 历史数据保留至少3个月 |
| FR-3.4 | 支持数据导出（CSV格式） |

#### 2.1.4 智能分析需求

| 需求编号 | 需求描述 |
|---------|---------|
| FR-4.1 | 计算THI（温湿度指数）评估热应激等级 |
| FR-4.2 | 计算AQI（空气质量指数）评估空气质量 |
| FR-4.3 | 基于环境参数预测产奶量损失 |
| FR-4.4 | 环境综合评分（0-100分） |
| FR-4.5 | 智能动态阈值调整 |

#### 2.1.5 告警需求

| 需求编号 | 需求描述 |
|---------|---------|
| FR-5.1 | 根据阈值自动判断环境异常 |
| FR-5.2 | 支持多级告警（一般、警告、严重） |
| FR-5.3 | 实时推送告警信息至前端界面 |
| FR-5.4 | 记录告警历史和处理情况 |
| FR-5.5 | 告警去重（10分钟内不重复触发） |

#### 2.1.6 设备控制需求

| 需求编号 | 需求描述 |
|---------|---------|
| FR-6.1 | 支持手动和自动两种控制模式 |
| FR-6.2 | 自动模式下根据环境参数联动控制设备 |
| FR-6.3 | 控制设备包括：风机、卷帘、供热、喷淋 |
| FR-6.4 | 所有控制操作记录日志 |

#### 2.1.7 可视化需求

| 需求编号 | 需求描述 |
|---------|---------|
| FR-7.1 | 实时展示当前环境参数（数值卡片） |
| FR-7.2 | 历史数据趋势图表（ECharts折线图） |
| FR-7.3 | 网络拓扑图展示节点分布和状态 |
| FR-7.4 | 产奶量趋势图和环境评分仪表盘 |
| FR-7.5 | 数据自动刷新（30秒/次） |

### 2.2 非功能性需求

#### 2.2.1 性能需求

| 指标 | 要求 |
|-----|------|
| 系统响应时间 | < 500ms |
| API响应时间 | < 100ms |
| 并发用户数 | ≥ 10人 |
| 数据存储容量 | ≥ 100万条记录 |
| 系统可用性 | 99%以上 |

#### 2.2.2 可靠性需求

- 节点故障不影响整体系统运行
- 数据传输失败支持自动重传
- 系统异常自动恢复
- 完善的错误处理和日志记录

#### 2.2.3 可扩展性需求

- 支持增加新的传感器节点（最多100个）
- 支持扩展新的传感器类型（光照、CO₂等）
- 支持增加新的控制设备
- 预留接口供第三方系统集成

#### 2.2.4 兼容性需求

- 前端兼容主流浏览器（Chrome、Firefox、Edge）
- 后端支持Windows、Linux、macOS部署
- 数据库兼容MySQL 8.0+

---

## 三、功能设计

### 3.1 系统总体架构

系统采用**分层架构设计**，从下至上分为四层：

```
┌─────────────────────────────────────────────────────────────────┐
│                    表示层 (Presentation Layer)                   │
│            Vue 3 + TypeScript + Element Plus + ECharts           │
│                  Web前端 - 数据可视化与人机交互界面                 │
├─────────────────────────────────────────────────────────────────┤
│                  应用服务层 (Application Service)                 │
│              Spring Boot + MyBatis + MySQL + WebSocket            │
│                后端服务 - 业务逻辑与数据处理                        │
├─────────────────────────────────────────────────────────────────┤
│                      网关层 (Gateway Layer)                       │
│                  ZigBee协调器 + Socket通信服务                     │
│                    数据汇聚与协议转换                              │
├─────────────────────────────────────────────────────────────────┤
│                      感知层 (Perception Layer)                    │
│             Python传感器模拟器 + ZigBee终端节点                    │
│                  环境参数采集与数据上报                            │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 核心功能模块

#### 3.2.1 数据监控模块

**功能描述**：实时显示牛棚环境状态

| 子功能 | 说明 |
|-------|------|
| 实时数据卡片 | 显示温度、湿度、NH₃、H₂S、产奶量、THI、AQI、环境评分 |
| 节点统计 | 显示节点总数、在线数、离线数 |
| 设备统计 | 显示设备总数、运行中、已停止、离线 |
| 趋势图表 | 温湿度趋势图、气体浓度趋势图、产奶量趋势图 |
| 环境评分 | 0-100分仪表盘实时显示 |
| 最新告警 | 显示最近告警信息列表 |

#### 3.2.2 节点管理模块

**功能描述**：管理所有传感器节点

| 子功能 | 说明 |
|-------|------|
| 节点列表 | 显示所有节点的ID、名称、位置、状态 |
| 状态监控 | 在线/离线状态、电池电量、信号强度 |
| 网络拓扑 | 星型拓扑可视化，协调器居中，节点环绕 |
| 节点操作 | 查看详情、编辑信息、删除节点 |
| 节点筛选 | 按状态、关键词搜索 |

#### 3.2.3 告警管理模块

**功能描述**：管理和处理环境告警

| 子功能 | 说明 |
|-------|------|
| 告警列表 | 分页展示所有告警记录 |
| 多维筛选 | 按级别、类型、状态、时间范围筛选 |
| 告警处理 | 标记处理状态，填写处理意见 |
| 告警统计 | 统计各类告警的数量和频率 |
| 批量操作 | 批量处理、删除告警记录 |

#### 3.2.4 设备控制模块

**功能描述**：控制执行设备

| 子功能 | 说明 |
|-------|------|
| 设备卡片 | 展示风机、卷帘、供热、喷淋状态 |
| 实时状态 | 运行/停止、自动/手动模式 |
| 远程控制 | 启动、停止设备 |
| 模式切换 | 自动模式/手动模式切换 |
| 控制日志 | 操作人、操作时间、操作原因 |

#### 3.2.5 历史数据模块

**功能描述**：查询和分析历史数据

| 子功能 | 说明 |
|-------|------|
| 条件查询 | 按节点、时间范围查询 |
| 数据表格 | 列表展示历史记录（含THI、AQI、产奶量） |
| 趋势分析 | 生成历史数据趋势图 |
| 数据导出 | 导出CSV格式数据 |

#### 3.2.6 系统配置模块

**功能描述**：配置系统参数

| 子功能 | 说明 |
|-------|------|
| 阈值配置 | 设置各参数的告警阈值 |
| 采集配置 | 配置数据采集周期 |
| 控制策略 | 配置自动控制规则 |
| 缓存刷新 | 刷新配置缓存 |

### 3.3 数据融合与智能分析功能

#### 3.3.1 THI（温湿度指数）计算

评估奶牛热应激程度的核心指标：

$$THI = (1.8 \times T + 32) - [(0.55 - 0.0055 \times RH) \times (1.8 \times T - 26)]$$

| THI范围 | 应激等级 | 产奶量影响 | 建议措施 |
|--------|---------|-----------|---------|
| < 68 | 无应激(舒适) | 0% | 无需处理 |
| 68-72 | 轻度应激 | -5%~-10% | 加强通风 |
| 72-79 | 中度应激 | -10%~-20% | 开启降温设备 |
| ≥ 79 | 严重应激 | -20%~-40% | 紧急降温+补充水分 |

#### 3.3.2 AQI（空气质量指数）计算

$$AQI = 0.6 \times \frac{NH_3}{50} + 0.4 \times \frac{H_2S}{20}$$

| AQI范围 | 质量等级 | 产奶量影响 | 建议措施 |
|--------|---------|-----------|---------|
| < 0.3 | 优(良好) | 0% | 维持当前状态 |
| 0.3-0.6 | 良(一般) | -5%~-15% | 增强通风 |
| ≥ 0.6 | 差 | -15%~-30% | 强制通风+清理 |

#### 3.3.3 产奶量预测模型

$$MilkYield = BaseMilk \times (1 - L_{THI}) \times (1 - L_{AQI}) \times (1 + R)$$

- BaseMilk: 基础产奶量 (25-30 kg/天)
- L_THI: THI导致的损失率 (0-0.40)
- L_AQI: AQI导致的损失率 (0-0.30)
- R: 随机波动因子 (±5%)

#### 3.3.4 动态阈值系统

根据环境状况自适应调整告警阈值：

**温度阈值调整**：
- THI ≥ 72（已应激）：阈值降低2℃（更严格）
- THI < 65（舒适）：阈值升高1℃（可放宽）

**气体阈值调整**：
- AQI ≥ 0.6（质量差）：阈值 × 0.8（更严格）
- AQI < 0.3（质量好）：阈值 × 1.1（可放宽）

---

## 四、软硬件模块设计

### 4.1 硬件架构（概念设计）

#### 4.1.1 传感器节点

| 组件 | 型号/规格 | 功能说明 |
|-----|---------|---------|
| **微控制器** | CC2530 | ZigBee芯片，集成MCU和RF收发器 |
| **温湿度传感器** | DHT22 | 温度精度±0.5℃，湿度精度±2% |
| **氨气传感器** | MQ-137 | 检测范围0-100ppm，灵敏度高 |
| **硫化氢传感器** | MQ-136 | 检测范围0-50ppm，响应快速 |
| **供电模块** | 锂电池 | 3.7V 2000mAh，支持低功耗休眠 |
| **天线** | 2.4GHz陶瓷天线 | 通信距离50-100米 |

**节点工作流程**：
```
传感器采集 → 数据处理 → ZigBee封装 → 无线发送 → 休眠省电
```

#### 4.1.2 ZigBee协调器

| 组件 | 型号/规格 | 功能说明 |
|-----|---------|---------|
| **主控芯片** | CC2530 | ZigBee协调器角色 |
| **串口转换** | CH340/FT232 | USB转TTL，连接PC |
| **指示灯** | LED | 工作状态指示 |

**功能**：
- 组建ZigBee网络（PAN ID: 0x1234）
- 接收各节点数据
- 通过串口/Socket上传至上位机

#### 4.1.3 执行设备

| 设备 | 功能 | 控制方式 |
|-----|------|---------|
| **风机** | 通风换气，降低有害气体浓度 | 继电器控制 |
| **卷帘** | 调节光照和空气流通 | 电机驱动 |
| **供热系统** | 冬季保温 | 继电器控制 |
| **喷淋系统** | 降温加湿 | 电磁阀控制 |

### 4.2 软件架构

#### 4.2.1 后端架构（Spring Boot）

**技术栈**：

| 技术 | 版本 | 用途 |
|-----|------|------|
| Java | JDK 21 | 开发语言 |
| Spring Boot | 2.7.18 | 应用框架 |
| MyBatis | 3.5.14 | ORM框架 |
| MySQL | 8.0+ | 关系型数据库 |
| HikariCP | - | 数据库连接池 |

**分层设计**：
```
Controller层（控制器）
    ↓ 接收HTTP请求，返回JSON
Service层（业务逻辑）
    ↓ 处理业务规则，数据融合分析
Mapper层（数据访问）
    ↓ MyBatis数据库操作
Database层（MySQL）
```

**核心服务类**：

| 类名 | 功能 |
|-----|------|
| SensorDataService | 传感器数据处理、存储、查询 |
| NodeService | 节点管理、状态更新 |
| AlarmService | 告警判断、记录、处理 |
| DeviceService | 设备控制、日志记录 |
| ConfigService | 系统配置管理 |
| DataFusionService | THI/AQI计算、产奶量预测、动态阈值 |

#### 4.2.2 前端架构（Vue 3）

**技术栈**：

| 技术 | 版本 | 用途 |
|-----|------|------|
| Vue | 3.3+ | 渐进式JavaScript框架 |
| TypeScript | 5.0+ | 类型安全 |
| Vite | 5.0+ | 构建工具 |
| Element Plus | 2.4+ | UI组件库 |
| ECharts | 5.4+ | 数据可视化 |
| Axios | - | HTTP客户端 |
| Vue Router | 4.0+ | 路由管理 |

**项目结构**：
```
frontend/
├── src/
│   ├── api/          # API接口封装（5个模块）
│   ├── assets/       # 静态资源
│   ├── components/   # 公共组件（8个）
│   ├── router/       # 路由配置
│   ├── types/        # TypeScript类型定义
│   ├── utils/        # 工具函数
│   ├── views/        # 页面组件（6个）
│   └── App.vue       # 根组件
```

**6个主要页面**：
1. **DashboardView** - 数据监控大屏（8个数据卡片+4个图表）
2. **NodesView** - 节点管理（列表+网络拓扑图）
3. **AlarmsView** - 告警管理（筛选+列表+统计）
4. **DevicesView** - 设备控制（卡片+控制+日志）
5. **HistoryView** - 历史数据（查询+表格+图表+导出）
6. **SettingsView** - 系统配置（阈值+参数配置）

#### 4.2.3 传感器模拟器架构（Python）

**技术栈**：

| 技术 | 版本 | 用途 |
|-----|------|------|
| Python | 3.7+ | 开发语言 |
| PyYAML | 6.0+ | 配置文件解析 |
| Socket | - | 网络通信 |

**项目结构**：
```
sensor_simulator/
├── main.py              # 主程序入口
├── config.py            # 配置管理
├── config.yaml          # YAML配置文件
├── data_generator.py    # 数据生成模块
├── zigbee_protocol.py   # ZigBee协议模拟
├── communication.py     # 通信模块
└── requirements.txt     # 依赖
```

**核心模块**：

| 模块 | 功能 |
|-----|------|
| SensorNode | 传感器节点类，独立线程运行 |
| SensorDataGenerator | 生成温湿度、气体浓度数据 |
| ZigBeeProtocol | 数据包编码、校验和计算 |
| SocketCommunicator | TCP Socket通信，自动重连 |

#### 4.2.4 数据库设计（MySQL）

**7张核心数据表**：

| 表名 | 说明 | 主要字段 |
|-----|------|---------|
| sensor_data | 传感器数据表 | node_id, temperature, humidity, nh3, h2s, milk_yield, collect_time |
| node_info | 节点信息表 | node_id, node_name, location, status, battery_level |
| alarm_info | 告警记录表 | alarm_type, alarm_level, status, current_value, threshold_value |
| device_info | 设备信息表 | device_id, device_type, status, control_mode |
| device_control_log | 设备控制日志 | device_id, control_action, operator, control_time |
| system_config | 系统配置表 | config_key, config_value, description |
| user | 用户表 | username, password, role |

---

## 五、传感器网络数据

### 5.1 数据采集

#### 5.1.1 采集参数规格

| 参数 | 传感器型号 | 量程 | 精度 | 正常范围 |
|-----|----------|------|------|---------|
| 温度 | DHT22 | -10~50°C | ±0.5°C | 15~28°C |
| 湿度 | DHT22 | 20~90% | ±2% | 50~75% |
| NH₃浓度 | MQ-137 | 0~100 ppm | ±1 ppm | 5~15 ppm |
| H₂S浓度 | MQ-136 | 0~50 ppm | ±0.5 ppm | 0~5 ppm |

#### 5.1.2 采集周期配置

| 配置项 | 默认值 | 可配置范围 |
|-------|-------|----------|
| 数据采集周期 | 30秒 | 10~60秒 |
| 数据上报周期 | 30秒 | 10~60秒 |
| 节点休眠时间 | 25秒 | 5~55秒 |

#### 5.1.3 数据生成模式

**正常模式**：
```python
# 温度：基准值 + 正弦趋势 + 高斯噪声
center = 21.5  # 中心温度
amplitude = 6.5  # 振幅
trend = amplitude * 0.5 * sin(2π * time / period + offset)
noise = gaussian(0, accuracy * noise_level)
temperature = center + trend + noise
```

**异常模式**：
```python
# 50%概率低温，50%概率高温
if random() < 0.5:
    temperature = uniform(0, 10)   # 低温异常
else:
    temperature = uniform(35, 45)  # 高温异常
```

**混合模式**：
```python
# 根据概率切换正常/异常
if random() < abnormal_probability:
    generate_abnormal_data()
else:
    generate_normal_data()
```

### 5.2 数据格式

#### 5.2.1 传感器原始数据

```json
{
  "node_id": "NODE_001",
  "timestamp": "2025-12-16 14:30:00",
  "temperature": 23.4,
  "humidity": 65.3,
  "nh3": 15.5,
  "h2s": 5.1,
  "milk_yield": 27.8,
  "battery_level": 85,
  "signal_strength": 78
}
```

#### 5.2.2 ZigBee数据包格式

```json
{
  "header": "7E",
  "pan_id": "0x1234",
  "source_address": "0x0001",
  "destination_address": "0x0000",
  "channel": 11,
  "sequence_number": 1,
  "payload": {
    "node_id": "NODE_001",
    "timestamp": "2025-12-16 14:30:00",
    "data": {
      "temperature": 23.4,
      "humidity": 65.3,
      "nh3": 15.5,
      "h2s": 5.1,
      "milk_yield": 27.8
    },
    "status": {
      "battery_level": 85,
      "signal_strength": 78
    }
  },
  "checksum": "0xA5"
}
```

### 5.3 网络拓扑

本系统采用**星型拓扑**结构：

```
                    ┌──────────────┐
                    │   协调器     │
                    │  Coordinator │
                    │   0x0000     │
                    └──────┬───────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
    ┌─────▼─────┐    ┌─────▼─────┐    ┌─────▼─────┐
    │  NODE_001 │    │  NODE_002 │    │  NODE_003 │
    │  牛棚1号   │    │  牛棚2号   │    │  牛棚3号   │
    │  0x0001   │    │  0x0002   │    │  0x0003   │
    └───────────┘    └───────────┘    └───────────┘
```

**拓扑优点**：
- ✅ 结构简单，易于管理
- ✅ 功耗较低
- ✅ 延迟小于5秒
- ✅ 适合中小规模网络

### 5.4 数据存储

#### 5.4.1 实时数据

- 存储位置：MySQL sensor_data表
- 更新频率：30秒/次
- 缓存机制：最新数据缓存便于快速查询

#### 5.4.2 历史数据

- 按时间索引，支持范围查询
- 支持按节点ID、参数类型筛选
- 分页查询，默认每页20条

#### 5.4.3 数据统计

系统自动计算：
- 每小时平均值、最大值、最小值
- THI/AQI指数和环境评分
- 产奶量预测值

---

*（文档未完，后续章节将包含：融合分析决策、网关设计、应用界面网页、具体工作、系统完成、系统测试）*
