# 牛舍环境监测系统 - 后端业务逻辑文档

## 📋 系统概述

### 项目定位
基于Spring Boot的RESTful API后端服务，负责处理传感器数据接收、存储、分析及设备控制等核心业务逻辑。

### 技术栈
- **框架**: Spring Boot 2.7.18
- **ORM**: MyBatis 2.3.2
- **数据库**: MySQL 8.0
- **通信**: Socket (端口8888)
- **构建**: Maven
- **日志**: Slf4j + Logback

---

## 🏗️ 系统架构

### 分层架构
```
Controller层 (API接口)
    ↓
Service层 (业务逻辑)
    ↓
Mapper层 (数据访问)
    ↓
Database (MySQL)
```

### 核心模块
1. **数据接收模块**: Socket服务器接收传感器数据
2. **数据处理模块**: 数据验证、计算、存储
3. **告警模块**: 阈值检测、告警生成与处理
4. **设备控制模块**: 自动/手动设备控制
5. **节点管理模块**: 节点信息维护
6. **系统配置模块**: 阈值配置管理

---

## 📡 数据接收流程

### Socket服务器
- **监听端口**: 8888
- **数据格式**: JSON
- **接收流程**:
  ```
  传感器节点 → Socket:8888 → 数据解析 → 数据验证 → 保存数据库 → 触发告警检测 → 触发设备控制
  ```

### 数据验证规则
- **温度**: -40℃ ~ 60℃
- **湿度**: 0% ~ 100%
- **氨气**: 0 ~ 200 ppm
- **硫化氢**: 0 ~ 100 ppm
- **节点ID**: 格式校验

---

## 💾 核心实体模型

### 1. SensorData (传感器数据)
```java
- nodeId: 节点ID
- temperature: 温度(℃)
- humidity: 湿度(%)
- nh3Concentration: 氨气浓度(ppm)
- h2sConcentration: 硫化氢浓度(ppm)
- milkYield: 产奶量(kg/天)
- createTime: 接收时间
```

### 2. AlarmRecord (告警记录)
```java
- nodeId: 节点ID
- alarmType: 告警类型(TEMP/HUMI/NH3/H2S)
- alarmLevel: 告警级别(1-一般/2-严重)
- currentValue: 当前值
- threshold: 阈值
- handleStatus: 处理状态(0-未处理/1-已处理)
```

### 3. DeviceInfo (设备信息)
```java
- deviceId: 设备ID
- deviceType: 设备类型(FAN/CURTAIN/HEATING/SPRAY)
- status: 运行状态(0-关闭/1-运行)
- autoMode: 控制模式(0-手动/1-自动)
```

### 4. NodeInfo (节点信息)
```java
- nodeId: 节点ID
- nodeName: 节点名称
- location: 安装位置
- status: 状态(0-离线/1-在线/2-故障)
- batteryLevel: 电池电量(%)
- signalStrength: 信号强度
```

---

## 🔧 业务服务层

### 1. SensorDataService (传感器数据服务)

#### 核心功能
- **数据保存**: 验证并保存传感器数据
- **产奶量预测**: 基于环境参数计算产奶量
- **数据查询**: 支持分页、时间范围查询
- **统计分析**: 计算平均值、最大值、最小值

#### 关键算法

**THI指数计算** (温湿度指数):
```
THI = (1.8 × T + 32) - [(0.55 - 0.0055 × RH) × (1.8 × T - 26)]
```

**AQI指数计算** (空气质量):
```
AQI = 0.6 × (NH₃/50) + 0.4 × (H₂S/20)
```

**产奶量预测**:
```
预测产奶量 = 基础产奶量 × (1 - THI损失率) × (1 - AQI损失率) × (1 + 随机因子)
```

---

### 2. AlarmService (告警服务)

#### 告警检测逻辑
1. 获取配置的告警阈值
2. 比较当前值与阈值
3. 判断告警级别
4. 生成告警记录

#### 告警阈值示例
- **温度**: 一级阈值35℃, 二级阈值40℃
- **湿度**: 一级阈值75%, 二级阈值85%
- **氨气**: 一级阈值25ppm, 二级阈值40ppm
- **硫化氢**: 一级阈值10ppm, 二级阈值20ppm

#### 告警去重
- 相同节点、相同类型的告警在10分钟内只生成一次

---

### 3. DeviceControlService (设备控制服务)

#### 自动控制策略

**氨气控制** (NH3):
```
- NH3 ≥ 40ppm: 启动风机 (严重)
- NH3 ≥ 25ppm: 启动风机 (警告)
- NH3 < 20ppm: 关闭风机 (恢复正常)
```

**硫化氢控制** (H2S):
```
- H2S ≥ 20ppm: 启动风机 (严重)
- H2S ≥ 10ppm: 启动风机 (警告)
- H2S < 8ppm: 关闭风机 (恢复正常)
```

**温度控制**:
```
- 温度 > 35℃: 打开窗帘通风
- 温度 < 33℃: 关闭窗帘
- 温度 < 5℃: 启动加热器
- 温度 > 7℃: 关闭加热器
```

#### 控制模式
- **手动模式**: 用户通过前端手动控制
- **自动模式**: 系统根据阈值自动控制
- **防抖处理**: 避免频繁开关（留有缓冲区间）

---

### 4. NodeInfoService (节点信息服务)

#### 功能列表
- 节点CRUD操作
- 在线状态统计
- 网络拓扑数据生成
- 节点存在性校验

---

### 5. SystemConfigService (系统配置服务)

#### 配置项管理
- 告警阈值配置
- 设备控制参数
- 系统运行参数
- 支持动态修改

---

## 🌐 REST API接口

### 传感器数据接口 (SensorDataController)

#### 1. 获取最新数据
```
GET /api/sensor/latest
返回: 所有节点的最新数据列表
```

#### 2. 查询历史数据
```
GET /api/sensor/history
参数:
  - nodeId: 节点ID (可选)
  - startTime: 开始时间 (YYYY-MM-DD HH:mm:ss)
  - endTime: 结束时间
  - pageNum: 页码
  - pageSize: 每页数量
返回: 分页数据 {list, total, pageNum, pageSize}
```

#### 3. 获取统计信息
```
GET /api/sensor/statistics
参数: nodeId, startTime, endTime
返回: {avgTemperature, avgHumidity, avgNh3, avgH2s, ...}
```

---

### 节点管理接口 (NodeController)

#### 1. 获取节点列表
```
GET /api/node/list?pageNum=1&pageSize=10
```

#### 2. 获取在线节点数
```
GET /api/node/online/count
```

#### 3. 获取网络拓扑
```
GET /api/node/topology
返回: 节点关系图数据
```

#### 4. 添加节点
```
POST /api/node
Body: NodeInfo对象
```

#### 5. 更新节点
```
PUT /api/node/{nodeId}
Body: NodeInfo对象
```

#### 6. 删除节点
```
DELETE /api/node/{nodeId}
```

---

### 告警管理接口 (AlarmController)

#### 1. 获取告警列表
```
GET /api/alarm/list
参数: nodeId, alarmType, alarmLevel, handleStatus, startTime, endTime, pageNum, pageSize
```

#### 2. 获取未处理告警数
```
GET /api/alarm/unhandled/count
```

#### 3. 处理告警
```
PUT /api/alarm/handle/{id}
Body: {handleStatus, handleRemark}
```

#### 4. 批量处理告警
```
PUT /api/alarm/handle/batch
Body: {ids: [1,2,3], handleStatus, handleRemark}
```

#### 5. 告警统计
```
GET /api/alarm/statistics
参数: startTime, endTime
返回: {total, unhandled, handled, byType, byLevel}
```

#### 6. 删除历史告警
```
DELETE /api/alarm/history
参数: beforeTime
```

---

### 设备控制接口 (DeviceController)

#### 1. 获取设备列表
```
GET /api/device/list?deviceType=FAN
```

#### 2. 获取运行中设备数
```
GET /api/device/running/count
```

#### 3. 手动控制设备
```
POST /api/device/control
Body: {deviceId, action: "START/STOP", operator}
```

#### 4. 切换控制模式
```
PUT /api/device/{deviceId}/mode
Body: {autoMode: 0/1}
```

#### 5. 获取控制日志
```
GET /api/device/log
参数: deviceId, controlType, startTime, endTime, page, pageSize
```

---

## 🔄 业务流程

### 数据接收与处理流程
```
1. Socket接收数据
2. 解析JSON格式
3. 数据格式验证
4. 计算THI、AQI、产奶量
5. 保存到数据库
6. 触发告警检测
7. 触发设备自动控制
8. 记录日志
```

### 告警处理流程
```
1. 接收传感器数据
2. 获取告警阈值配置
3. 判断是否超过阈值
4. 确定告警级别
5. 检查告警去重
6. 生成告警记录
7. (可选)发送通知
```

### 自动控制流程
```
1. 检测环境参数
2. 判断是否需要控制
3. 查询设备信息
4. 检查设备模式(自动/手动)
5. 执行控制命令
6. 更新设备状态
7. 记录控制日志
```

---

## ⚙️ 配置说明

### application.yml 核心配置

```yaml
# 数据源配置
datasource:
  url: jdbc:mysql://localhost:3306/wsn_cow_monitor
  username: root
  password: root

# Socket通信配置
serial:
  socket:
    port: 8888        # 监听端口
    host: 0.0.0.0     # 监听地址

# 告警配置
alarm:
  enabled: true
  deduplicate-interval: 600  # 告警去重间隔(秒)

# 设备控制配置
device:
  auto-control-enabled: true
  control-delay: 300  # 控制延迟(秒)
```

---

## 📊 数据库设计

### 核心表结构

#### sensor_data (传感器数据表)
- 存储所有传感器采集的环境数据
- 包含计算字段: milkYield(产奶量)
- 索引: nodeId, createTime

#### alarm_record (告警记录表)
- 存储所有告警事件
- 索引: nodeId, alarmTime, handleStatus

#### device_info (设备信息表)
- 存储设备基本信息和状态
- 索引: deviceId, deviceType

#### node_info (节点信息表)
- 存储传感器节点信息
- 索引: nodeId, status

#### system_config (系统配置表)
- 存储系统配置参数
- Key-Value结构

---

## 🔐 数据验证

### ValidationUtils 工具类

```java
- isValidNodeId(): 节点ID格式验证
- isValidTemperature(): 温度范围 -40~60℃
- isValidHumidity(): 湿度范围 0~100%
- isValidNH3(): 氨气范围 0~200ppm
- isValidH2S(): 硫化氢范围 0~100ppm
```

---

## 📝 日志管理

### 日志级别
- **INFO**: 正常业务流程
- **WARN**: 数据验证失败、告警触发
- **ERROR**: 异常情况、控制失败
- **DEBUG**: 详细调试信息

### 日志文件
- 路径: `logs/cow-monitor.log`
- 大小: 10MB自动滚动
- 保留: 30天历史日志

---

## 🚀 启动方式

### 标准启动
```bash
java -jar cow-monitor-backend.jar
```

### Socket服务器独立启动
```bash
java -cp cow-monitor-backend.jar com.wsn.cow.SocketServerStarter
```

### 端口说明
- **9090**: Spring Boot HTTP服务
- **8888**: Socket数据接收服务

---

## 🔍 关键业务逻辑

### 产奶量损失率计算

#### THI损失率
```
THI < 68:  0% (无应激)
68-72:     5%-10% (轻度应激)
72-79:     10%-20% (中度应激)
≥79:       20%-40% (重度应激)
```

#### AQI损失率
```
AQI < 0.3:  0% (良好)
0.3-0.6:    5%-15% (中等)
≥0.6:       15%-30% (较差)
```

### 环境综合评分
```
评分 = THI评分 × 0.6 + AQI评分 × 0.4

评估标准:
- 优秀: ≥85分
- 良好: 70-85分
- 一般: 60-70分
- 较差: <60分
```

---

## 🛠️ 异常处理

### 全局异常处理器 (GlobalExceptionHandler)
- 统一捕获业务异常
- 统一返回格式
- 记录异常日志

### Result统一返回格式
```json
{
  "code": 200,
  "msg": "success",
  "data": {...}
}
```

---

## 📈 性能优化

### 1. 数据库优化
- 合理使用索引
- 分页查询避免全表扫描
- 批量插入提高效率

### 2. 缓存策略
- 告警阈值缓存
- 配置信息缓存

### 3. 异步处理
- 告警检测异步执行
- 设备控制异步执行

---

## 🔄 定时任务

### 清理历史数据
- 定期清理90天前的传感器数据
- 定期清理已处理的告警记录
- 默认每天凌晨2点执行

---

## 📦 依赖说明

### 核心依赖
- `spring-boot-starter-web`: Web框架
- `mybatis-spring-boot-starter`: ORM框架
- `mysql-connector-j`: MySQL驱动
- `lombok`: 代码简化
- `jSerialComm`: 串口通信

---

## 🎯 业务特点总结

### 1. 智能化
- 自动阈值检测
- 智能设备控制
- 产奶量预测

### 2. 实时性
- Socket实时数据接收
- 毫秒级告警响应
- 即时设备控制

### 3. 可靠性
- 数据验证机制
- 异常处理完善
- 日志追踪完整

### 4. 可扩展性
- 模块化设计
- 配置化管理
- 易于扩展新功能

---

**文档版本**: v1.0  
**更新日期**: 2025-11-19  
**维护人员**: 后端开发组
